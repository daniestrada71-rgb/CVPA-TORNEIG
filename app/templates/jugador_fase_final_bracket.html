<!DOCTYPE html>
<html lang="ca">
<head>
<meta charset="utf-8" />
<title>Quadre â€” {{ fase }}</title>
<meta name="viewport" content="width=device-width,initial-scale=1" />
<style>
:root{
  --bg:#f9f9f9; --card:#fff; --accent:#800000;
  --gold: #D4AF37; --silver: #C0C0C0; --bronze: #CD7F32; --show: #DA70D6;
  --match-w: 180px; --match-h: 72px;
}
body{font-family:Arial,Segoe UI,Roboto; background:var(--bg); margin:0; padding:18px;}
.header{display:flex;align-items:center;gap:12px;margin-bottom:8px;}
.title-wrap{flex:1; display:flex; justify-content:center; align-items:center;}
.h1-title{margin:0;font-size:22px;font-weight:800; letter-spacing:1px;}
.container{background:transparent;padding-top:12px; display:flex; justify-content:center;}
.canvas-wrap{position:relative; width:1200px; height:720px; background:transparent; border-radius:8px;}
.match{
  position:absolute;
  width:var(--match-w);
  height:var(--match-h);
  background:var(--card);
  border-radius:8px;
  padding:8px;
  box-shadow:0 2px 8px rgba(0,0,0,0.08);
  text-align:left;
  box-sizing:border-box;
  cursor:default;
  pointer-events: none; /* IMPORTANT: disable interaction for jugador */
}
.match .title{font-weight:700;color:#333;margin-bottom:6px;font-size:13px;}
.slot-compact{display:flex;justify-content:space-between;align-items:center;padding:4px 6px;border-radius:5px;background:#fff;border:1px solid #eee;font-size:13px;}
.slot-compact.empty{opacity:0.5;color:#999;}
.slot-compact.win{background:#dff0d8;color:#006400;border-color:#c7e6c7;}
.slot-compact.lose{background:#ffd6d6;color:#8b0000;border-color:#f2c6c6;}
.status{font-size:13px;color:#444;margin-left:8px;}
.titol-centered{display:block;text-align:center;font-size:26px;font-weight:900;margin-bottom:10px;}
.back-rt { position: absolute; right: 18px; top: 18px; }
.btn { background:var(--accent);color:white;padding:8px 12px;border-radius:6px;border:0;cursor:pointer;font-weight:700;text-decoration:none; }
.btn.secondary{background:#444;}
/* phase color */
#titol_fase { color: var(--accent); }
.notice { max-width:1200px;margin:12px auto;color:#666;font-size:13px; text-align:center; }

/* =======================
   ðŸ“± ADAPTACIÃ“ A MÃ’BIL
   ======================= */
@media (max-width: 768px) {

  /* Redueix tot el bracket */
  .canvas-wrap {
      transform: scale(0.55);
      transform-origin: top left;
      width: 1200px;   /* mantÃ© mida real per no desposicionar */
      height: 720px;
  }

  /* Contenidor amb scroll suau si cal */
  .container {
      overflow-x: auto;
      padding-bottom: 40px;
  }

  /* BotÃ³ tornar ben posicionat */
  .back-rt {
      position: fixed;
      top: 10px;
      right: 10px;
      z-index: 50;
  }

  /* TÃ­tol mÃ©s gran i centrat */
  .h1-title {
      font-size: 20px;
      margin-top: 50px;
  }

  /* Text informatiu mÃ©s gran */
  .notice {
      font-size: 15px;
      padding: 10px;
  }

}

</style>
</head>
<body>
  <div style="position:relative; max-width:1200px; margin:0 auto;">
    <a class="back-rt" href="/jugador/fase-final" title="Tornar"><button class="btn secondary">â¬… Tornar</button></a>


    <div class="header" style="padding-top:10px;">
      <div class="title-wrap">
        <div id="titol_fase" class="h1-title">FASE FINAL â€” {{ fase }}</div>
      </div>
    </div>
  </div>

  <div class="container">
    <div class="canvas-wrap" id="canvas">
      <!-- Matches generated here (read-only) -->
    </div>
  </div>

  <div class="notice">
    Aquesta vista Ã©s **nomÃ©s lectura** per a jugadors â€” no es pot modificar res des dâ€™aquÃ­. Si vols que els resultats canviÃ¯n, accedeix a la zona dâ€™administraciÃ³.
  </div>

<script>
/* Minimal, read-only bracket renderer.
   - Carrega equips via /admin/fasefinal/api/equips/{FASE}
   - Carrega estat guardat via /admin/fasefinal/api/load/{FASE} (si existeix)
   - Renderitza caselles amb classes win/lose segons l'estat carregat
   - Cap event d'interacciÃ³ (pointer-events: none al CSS) */

const FASE = "{{ fase }}".toUpperCase();

/* Posicions (simplificades, adequades per N=8/9/10). Mantinc les mateixes constants que lâ€™admin per coherÃ¨ncia */
const POSITIONS_8 = {
  1: [40, 30],   2: [40, 130], 3: [40, 230], 4: [40, 330],
  5: [290, 400],  7: [290, 80],
  12: [800, 450],
  6: [290, 500], 8: [290, 180],
  9: [540, 400], 10: [540, 500],
  11: [540, 130],13: [865, 350],
  14: [990,200]
};
const POSITIONS_9 = {
  1: [10, 30],  2: [10, 130], 3: [10, 230], 4: [10, 330],
  5: [220, 80], 6: [200, 430], 7: [400, 430],
  8: [400, 530], 9: [460, 80], 10: [460, 180],
  11: [600, 430], 12: [600, 530], 13: [710, 130],
  14: [800, 480], 15: [900, 380], 16: [1000, 250]
};
const POSITIONS_10 = {
  1: [30, 30],  2: [30, 130],
  3: [250, 30], 4: [250, 130], 5: [250, 230], 6: [250, 330],
  7: [470, 360], 8: [470, 460],9: [470, 60], 10: [470, 220],
  11: [690, 360], 12: [690, 460],
  13: [910, 360], 14: [910, 460], 15: [690, 140], 16: [1130, 400], 17: [1200, 300], 18: [1300, 200]
};

/* STRUCTURES (copiades de l'admin, per renderitzat coherente) */
const BRACKETS_ALL = {
  8: {
    1:["E1","E8"], 2:["E4","E5"], 3:["E3","E6"], 4:["E2","E7"],
    5:["l_3","l_4"], 7:["w_1","w_2"], 6:["l_1","l_2"], 8:["w_3","w_4"],
    9:["w_5","l_7"], 10:["w_6","l_8"], 11:["w_7","w_8"],
    12:["w_9","w_10"], 13:["w_12","l_11"], 14:["w_11","w_13"]
  },
  9: {
    1:["E8","E9"],2:["E2","E7"],3:["E4","E5"],5:["E1","W_1"],4:["E3","E6"],
    6:["l_3","l_1"],7:["l_4","l_2"],8:["w_6","l_5"],9:["w_5","w_3"],
    10:["w_2","w_4"],11:["l_10","w_7"],12:["l_9","w_8"],13:["w_9","w_10"],
    14:["w_11","w_12"],15:["l_13","w_14"],16:["w_13","w_15"]
  },
  10: {
    1:["E7","E10"],2:["E8","E9"],3:["E4","E5"],4:["E3","E6"],5:["w_1","E1"],
    6:["w_2","E2"],7:["w_3","w_5"],8:["w_6","w_4"],9:["w_8","w_7"],
    10:["l_1","l_3"],11:["l_2","l_4"],12:["w_10","l_5"],13:["w_11","l_6"],
    14:["w_12","l_7"],15:["w_13","l_8"],16:["w_14","w_15"],17:["w_16","l_9"],18:["w_9","w_17"]
  }
};

let matches = {}; // read-only representation

async function init(){
  // 1) equips
  const res = await fetch(`/admin/fasefinal/api/equips/${FASE}`);
  const payload = await res.json();
  const equips = (payload.ok && payload.equips) ? payload.equips.map(x => x.equip) : [];

  const N = equips.length;
  const BRACKETS = BRACKETS_ALL[N];
  const POSITIONS = (N === 8) ? POSITIONS_8 : (N === 9) ? POSITIONS_9 : (N === 10) ? POSITIONS_10 : null;

  const canvas = document.getElementById('canvas');
  if(!BRACKETS || !POSITIONS){
    canvas.innerHTML = `<div style="color:#800000;padding:24px;font-weight:700;text-align:center">L'estructura estÃ  preparada per 8/9/10 equips. Heu assignat ${N} equips per a ${FASE} â€” ajusteu la configuraciÃ³ o trieu 8/9/10.</div>`;
    return;
  }

  // init matches object
  Object.keys(BRACKETS).forEach(k=>{
    const mid = parseInt(k);
    matches[mid] = {
      slot1_src: BRACKETS[mid][0],
      slot2_src: BRACKETS[mid][1],
      slot1: null, slot2: null, winner: null, loser: null
    };
  });

  // assign E1..EN
  Object.values(matches).forEach((m)=>{
    if(typeof m.slot1_src === 'string' && m.slot1_src.startsWith('E')) {
      const idx = parseInt(m.slot1_src.slice(1)) - 1;
      if(idx < equips.length) m.slot1 = equips[idx];
    }
    if(typeof m.slot2_src === 'string' && m.slot2_src.startsWith('E')) {
      const idx = parseInt(m.slot2_src.slice(1)) - 1;
      if(idx < equips.length) m.slot2 = equips[idx];
    }
  });

  // 2) try load saved state (if any) â€” apply winners/losers read-only
  try{
    const lres = await fetch(`/admin/fasefinal/api/load/${FASE}`);
    const ljson = await lres.json();
    if(ljson.ok && ljson.data){
      Object.keys(ljson.data).forEach(k=>{
        const mid = parseInt(k);
        if(matches[mid]){
          // copy relevant read-only fields if present
          const saved = ljson.data[k];
          if(saved.slot1) matches[mid].slot1 = saved.slot1;
          if(saved.slot2) matches[mid].slot2 = saved.slot2;
          if(saved.winner) matches[mid].winner = saved.winner;
          if(saved.loser) matches[mid].loser = saved.loser;
        }
      });
      document.getElementById('titol_fase').insertAdjacentHTML('afterend','<div style="text-align:center;color:#2b7a2b;font-weight:700;margin-top:6px;">(Estat carregat des del servidor)</div>');
    }
  }catch(e){
    // ignore load errors â€” continue showing base teams
    console.warn("No saved state or load failed", e);
  }

  // draw read-only
  draw(POSITIONS);
  colorTitle();
}

/* RENDER */
function makeMatchDiv(mid, m, maxId, posMap){
  const div = document.createElement('div');
  div.className = 'match';
  const pos = posMap[mid] || [50,50];
  div.style.left = pos[0] + 'px';
  div.style.top  = pos[1] + 'px';

  const title = document.createElement('div');
  title.className = 'title';
  title.innerText = (mid === maxId) ? 'FINAL' : `PARTIT ${mid}`;
  div.appendChild(title);

  const slotA = document.createElement('div');
  slotA.className = 'slot-compact' + (m.slot1 ? '' : ' empty');
  slotA.innerHTML = `<span style="font-weight:700">${formatSlotLabel(m.slot1_src)}</span><span>${m.slot1 || 'â€”'}</span>`;
  if(m.winner && m.winner === m.slot1) slotA.classList.add('win');
  if(m.loser && m.loser === m.slot1) slotA.classList.add('lose');

  const slotB = document.createElement('div');
  slotB.className = 'slot-compact' + (m.slot2 ? '' : ' empty');
  slotB.innerHTML = `<span style="font-weight:700">${formatSlotLabel(m.slot2_src)}</span><span>${m.slot2 || 'â€”'}</span>`;
  if(m.winner && m.winner === m.slot2) slotB.classList.add('win');
  if(m.loser && m.loser === m.slot2) slotB.classList.add('lose');

  div.appendChild(slotA);
  div.appendChild(slotB);
  return div;
}

function formatSlotLabel(src){
  if(!src) return '';
  if(typeof src !== 'string') return '';
  if(src.startsWith('E')) return '';
  if(src.startsWith('w_')) return `G.P.${src.split('_')[1]}`;
  if(src.startsWith('l_')) return `P.P.${src.split('_')[1]}`;
  return '';
}

function draw(posMap){
  const canvas = document.getElementById('canvas');
  canvas.innerHTML = '';
  const ids = Object.keys(matches).map(x=>parseInt(x)).sort((a,b)=>a-b);
  if(ids.length === 0) return;
  const maxId = Math.max(...ids);
  ids.forEach(mid=>{
    const m = matches[mid];
    const el = makeMatchDiv(mid,m,maxId,posMap);
    canvas.appendChild(el);
  });
}

function colorTitle(){
  const tit = document.getElementById('titol_fase');
  const fase = FASE.toUpperCase();
  if(fase === 'OR') tit.style.color = 'var(--gold)';
  else if(fase === 'PLATA') tit.style.color = 'var(--silver)';
  else if(fase === 'BRONZE') tit.style.color = 'var(--bronze)';
  else if(fase === 'SHOW' || fase === 'SHOW') tit.style.color = 'var(--show)';
}

/* Kick off */
init();
</script>
</body>
</html>




