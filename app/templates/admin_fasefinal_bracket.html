<!DOCTYPE html>
<html lang="ca">
<head>
<meta charset="utf-8" />
<title>Quadre ‚Äî {{ fase }}</title>
<meta name="viewport" content="width=device-width,initial-scale=1" />
<style>
:root{
  --bg:#f9f9f9; --card:#fff; --accent:#800000;
  --gold: #D4AF37; --silver: #C0C0C0; --bronze: #CD7F32; --show: #DA70D6;
  --match-w: 180px; --match-h: 72px;
}
body{font-family:Arial,Segoe UI,Roboto; background:var(--bg); margin:0; padding:18px;}
.header{display:flex;align-items:center;gap:12px;margin-bottom:8px;}
.volver{flex:0 0 auto;}
.title-wrap{flex:1; display:flex; justify-content:center; align-items:center;}
.h1-title{margin:0;font-size:22px;font-weight:800; letter-spacing:1px;}
.controls{display:flex;gap:8px;align-items:center;}
.btn{background:var(--accent);color:white;padding:8px 12px;border-radius:6px;border:0;cursor:pointer;font-weight:700;}
.btn.secondary{background:#444;}
.container{background:transparent;padding-top:12px; display:flex; justify-content:center;}
.canvas-wrap{position:relative; width:1200px; height:720px; background:transparent; border-radius:8px;}
.match{
  position:absolute;
  width:var(--match-w);
  height:var(--match-h);
  background:var(--card);
  border-radius:8px;
  padding:8px;
  box-shadow:0 2px 8px rgba(0,0,0,0.08);
  text-align:left;
  box-sizing:border-box;
  cursor:default;
}
.match .title{font-weight:700;color:#333;margin-bottom:6px;font-size:13px;}
.match .slot-compact{display:flex;justify-content:space-between;align-items:center;padding:3px 6px;border-radius:5px;background:#fff;border:1px solid #eee;font-size:13px;}
.match .slot-compact.disabled{opacity:0.5;}
.match .slot-compact.win{background:#dff0d8;color:#006400;border-color:#c7e6c7;}
.match .slot-compact.lose{background:#ffd6d6;color:#8b0000;border-color:#f2c6c6;}
.status{font-size:13px;color:#444;margin-left:8px;}
.titol-centered{display:block;text-align:center;font-size:26px;font-weight:900;margin-bottom:10px;}
/* phase color */
#titol_fase { color: var(--accent); }
</style>
</head>
<body>
<div class="header">
  <div class="volver">
    <a href="{{ url_for('admin_fasefinal.mostrar_quadres_finals') }}" class="btn">‚¨Ö Tornar</a>
  </div>

  <div class="title-wrap">
    <div id="titol_fase" class="h1-title">FASE FINAL ‚Äî {{ fase }}</div>
  </div>

  <div class="controls">
    <button id="btnReset" class="btn secondary">üîÅ Reset</button>
    <button id="btnSave" class="btn">üíæ Desar</button>
    <span id="status" class="status"></span>
  </div>
</div>

<div class="container">
  <div class="canvas-wrap" id="canvas">
    <!-- Les caselles es generaran din√†micament aqu√≠ -->
  </div>
</div>

<div style="max-width:1200px;margin:18px auto;color:#666;font-size:13px;">
  <strong>Nota:</strong> clica una slot per marcar guanyador (es posa verd). El perdedor queda en vermell. Els noms que provenen d‚Äôaltres partits apareixeran en format "G.P.X" o "P.P.X" (Guanyador/Perdedor Partit X). L‚Äôestat es desa autom√†ticament i pots pr√©mer <em>Desar</em> per for√ßar-ho.
</div>

<script>
/* ------------------------
   POSICIONS OPTIMITZADES per N=8,9,10
   (x,y) top-left per cada partida. He ajustat les coordenades
   per tenir una distribuci√≥ compacta semblant a Tkinter.
   ------------------------*/
const POSITIONS_8 = {
  1: [40, 30],   2: [40, 130], 3: [40, 230], 4: [40, 330],
  5: [290, 400],  7: [290, 80],
  12: [800, 450],
  6: [290, 500], 8: [290, 180],
  9: [540, 400], 10: [540, 500],
  11: [540, 130],13: [865, 350],
  14: [990,200]
};

const POSITIONS_9 = {
  // he distribu√Øt una columna extra a la dreta per encaixar 9
  1: [10, 30],  2: [10, 130], 3: [10, 230], 4: [10, 330],
  5: [220, 80], 6: [200, 430], 7: [400, 430],
  8: [400, 530], 9: [460, 80], 10: [460, 180],
  11: [600, 430], 12: [600, 530], 13: [710, 130],
  14: [800, 480], 15: [900, 380], 16: [1000, 250]
};

const POSITIONS_10 = {
  // una mica m√©s espai√≥s per 10 equips
  1: [30, 30],  2: [30, 130],
  3: [250, 30], 4: [250, 130], 5: [250, 230], 6: [250, 330],
  7: [500, 60], 8: [500, 220], 9: [750, 140],
  10: [500, 360], 11: [500, 460], 12: [750, 360], 13: [750, 460],
  14: [950, 420], 15: [950, 320], 16: [1000, 220]
};


/* ---- Bracket structures (copiades i adaptades de la teva versi√≥ Python) ---- */
const BRACKETS_ALL = {
  8: {
    1:["E1","E8"], 2:["E4","E5"], 3:["E3","E6"], 4:["E2","E7"],
    5:["l_3","l_4"], 7:["w_1","w_2"], 6:["l_1","l_2"], 8:["w_3","w_4"],
    9:["w_5","l_7"], 10:["w_6","l_8"], 11:["w_7","w_8"],
    12:["w_9","w_10"], 13:["w_12","l_11"], 14:["w_11","w_13"]
  },
  9: {
    1:["E8","E9"],2:["E2","E7"],3:["E4","E5"],5:["E1","W_1"],4:["E3","E6"],
    6:["l_3","l_1"],7:["l_4","l_2"],8:["w_6","l_5"],9:["w_5","w_3"],
    10:["w_2","w_4"],11:["l_10","w_7"],12:["l_9","w_8"],13:["w_9","w_10"],
    14:["w_11","w_12"],15:["l_13","w_14"],16:["w_13","w_15"]
  },
  10: {
    1:["E7","E10"],2:["E8","E9"],3:["E4","E5"],4:["E3","E6"],5:["w_1","E1"],
    6:["w_2","E2"],7:["w_3","w_5"],8:["w_6","w_4"],9:["w_8","w_7"],
    10:["l_1","l_3"],11:["l_2","l_4"],12:["w_10","l_5"],13:["w_11","l_6"],
    14:["w_12","l_7"],15:["w_14","l_9"],16:["w_9","w_15"]
  },
};

const TARGETS_ALL = {
  8: {
    1:{winner:[7,1], loser:[6,1]}, 2:{winner:[7,2], loser:[6,2]},
    3:{winner:[8,1], loser:[5,2]}, 4:{winner:[8,2], loser:[5,1]},
    5:{winner:[9,1], loser:null},7:{winner:[11,1], loser:[9,2]},
    6:{winner:[10,1], loser:null},8:{winner:[11,2], loser:[10,2]},
    9:{winner:[12,1], loser:null},10:{winner:[12,2], loser:null},
    11:{winner:[14,1], loser:[13,2]},12:{loser:[13,2], winner:[13,1]},
    13:{winner:[14,2], loser:null},14:{winner:null, loser:null}
  },
  9: {
    1:{winner:[5,2], loser:[6,2]},2:{winner:[10,1], loser:[7,2]},3:{winner:[9,2], loser:[6,1]},
    4:{winner:[10,2], loser:[7,1]},5:{winner:[9,1], loser:[8,2]},6:{winner:[8,1], loser:null},
    7:{winner:[11,2], loser:null},8:{winner:[12,2], loser:null},9:{winner:[13,1], loser:[12,1]},
    10:{winner:[13,2], loser:[11,1]},11:{winner:[14,1], loser:null},12:{winner:[14,2], loser:null},
    13:{winner:[16,1], loser:[15,1]},14:{winner:[15,2], loser:null},15:{winner:[16,2], loser:null},
    16:{winner:null, loser:null}
  },
  10: {
    1:{winner:[6,1], loser:[10,1]},2:{winner:[5,1], loser:[11,1]},3:{winner:[7,1], loser:[10,2]},
    4:{winner:[8,2], loser:[11,2]},5:{winner:[7,2], loser:[12,2]},6:{winner:[8,1], loser:[13,2]},
    7:{winner:[9,1], loser:[14,2]},8:{winner:[9,2], loser:[15,2]},9:{winner:[16,1], loser:[15,2]},
    10:{winner:[12,1], loser:null},11:{winner:[13,1], loser:null},12:{winner:[14,1], loser:null},
    13:{winner:[15,2], loser:null},14:{winner:[15,1], loser:null},15:{winner:[16,2], loser:null},
    16:{winner:null, loser:null}
};

/* Estat local */
let matches = {};   // matches[mid] = { slot1_src, slot2_src, slot1, slot2, winner, loser, fg1, fg2, targets }
const FASE = "{{ fase }}".toUpperCase();

/* Inicialitzar */
async function init(){
  // 1) carregar equips assignats a la fase (pos i nom)
  const res = await fetch(`/admin/fasefinal/api/equips/${FASE}`);
  const payload = await res.json();
  const equips = (payload.ok && payload.equips) ? payload.equips.map(x => x.equip) : [];

  // 2) seleccionar estructura segons N
  const N = equips.length;
  const BRACKETS = BRACKETS_ALL[N];
  const TARGETS = TARGETS_ALL[N];
  const POSITIONS = (N === 8) ? POSITIONS_8 : (N === 9) ? POSITIONS_9 : (N === 10) ? POSITIONS_10 : null;

  if(!BRACKETS || !POSITIONS){
    const canvas = document.getElementById('canvas');
    canvas.innerHTML = `<div style="color:#800000;padding:24px;font-weight:700">L'estructura est√† preparada per 8/9/10 equips. Heu assignat ${N} equips per a ${FASE} ‚Äî ajusteu la configuraci√≥ o trieu 8/9/10.</div>`;
    return;
  }

  // 3) init matches using structure
  Object.keys(BRACKETS).forEach(k=>{
    const mid = parseInt(k);
    matches[mid] = {
      slot1_src: BRACKETS[mid][0],
      slot2_src: BRACKETS[mid][1],
      slot1: null, slot2: null, winner: null, loser: null, fg1:"black", fg2:"black",
      targets: TARGETS[mid] || {}
    };
  });

  // 4) assign initial E1..En teams
  Object.values(matches).forEach(m=>{
    if(typeof m.slot1_src === 'string' && m.slot1_src.startsWith('E')){
      const idx = parseInt(m.slot1_src.slice(1)) - 1;
      if(idx < equips.length) m.slot1 = equips[idx];
    }
    if(typeof m.slot2_src === 'string' && m.slot2_src.startsWith('E')){
      const idx = parseInt(m.slot2_src.slice(1)) - 1;
      if(idx < equips.length) m.slot2 = equips[idx];
    }
  });

  // 5) try to load saved state
  try{
    const lres = await fetch(`/admin/fasefinal/api/load/${FASE}`);
    const ljson = await lres.json();
    if(ljson.ok && ljson.data){
      Object.keys(ljson.data).forEach(k=>{
        const mid = parseInt(k);
        if(matches[mid]) matches[mid] = {...matches[mid], ...ljson.data[k]};
      });
    }
  }catch(e){ console.warn("No saved state or load failed", e); }

  // store references for later use
  window.__POS_MAP = POSITIONS;
  window.__N = N;

  // 6) draw
  draw();
  attachControls();
}

/* Build DOM for one match */
function makeMatchDiv(mid, m, maxId){
  const div = document.createElement('div');
  div.className = 'match';
  // use positions mapping for current N
  const posMap = window.__POS_MAP || {};
  const pos = posMap[mid] || [50, 50];
  div.style.left = (pos[0]) + 'px';
  div.style.top  = (pos[1]) + 'px';

  // title (compact Pn)
  const title = document.createElement('div');
  title.className = 'title';
  title.innerText = (mid === maxId) ? 'FINAL' : `PARTIT ${mid}`;
  div.appendChild(title);

  // compact slot line: left = label (G.P.x if needed), right = team
  const slotA = document.createElement('div');
  slotA.className = 'slot-compact' + (m.slot1 ? '' : ' disabled');
  slotA.id = `m${mid}_s1`;
  slotA.innerHTML = `<span style="font-weight:700">${formatSlotLabel(m.slot1_src)}</span><span>${m.slot1 || '‚Äî'}</span>`;
  slotA.onclick = ()=> onClickSlot(mid,1);

  const slotB = document.createElement('div');
  slotB.className = 'slot-compact' + (m.slot2 ? '' : ' disabled');
  slotB.id = `m${mid}_s2`;
  slotB.innerHTML = `<span style="font-weight:700">${formatSlotLabel(m.slot2_src)}</span><span>${m.slot2 || '‚Äî'}</span>`;
  slotB.onclick = ()=> onClickSlot(mid,2);

  // apply win/lose classes
  if(m.winner){
    if(m.winner === m.slot1) { slotA.classList.add('win'); slotB.classList.add('lose'); }
    else { slotB.classList.add('win'); slotA.classList.add('lose'); }
  }

  div.appendChild(slotA);
  div.appendChild(slotB);

  return div;
}

/* format label: if slot source is 'E#' show '', if 'w_#' show G.P.# , if 'l_#' show P.P.# */
function formatSlotLabel(src){
  if(!src) return '';
  if(typeof src !== 'string') return '';
  if(src.startsWith('E')) return ''; // initial seed ‚Äî show nothing
  if(src.startsWith('w_')) return `G.P.${src.split('_')[1]}`;
  if(src.startsWith('l_')) return `P.P.${src.split('_')[1]}`;
  return '';
}

/* Draw all matches */
function draw(){
  const canvas = document.getElementById('canvas');
  canvas.innerHTML = '';
  const ids = Object.keys(matches).map(x=>parseInt(x)).sort((a,b)=>a-b);
  if(ids.length === 0) return;
  const maxId = Math.max(...ids);

  // render every match at its absolute position
  ids.forEach(mid=>{
    const m = matches[mid];
    const el = makeMatchDiv(mid, m, maxId);
    canvas.appendChild(el);
  });

  document.getElementById('status').innerText = '';
}

/* clicking a slot: set winner and propagate */
function onClickSlot(mid, slot){
  const m = matches[mid];
  if(!m) return;
  if(!m[`slot${slot}`]) return; // empty slot -> no action
  if(!m.slot1 || !m.slot2) return;

  const chosen = m[`slot${slot}`];
  if(m.winner === chosen){
    m.winner = null; m.loser = null; m.fg1 = "black"; m.fg2 = "black";
    // also clear targets where this name was propagated (simple approach: reload saved state or keep as-is)
  } else {
    if(slot === 1){ m.winner = m.slot1; m.loser = m.slot2; m.fg1="green"; m.fg2="red"; }
    else { m.winner = m.slot2; m.loser = m.slot1; m.fg1="red"; m.fg2="green"; }
  }

  // propagate to targets
  if(m.targets){
    if(m.winner && m.targets.winner){
      const [tmid, tslot] = m.targets.winner;
      if(matches[tmid]) matches[tmid][`slot${tslot}`] = m.winner;
    }
    if(m.loser && m.targets.loser){
      const t2 = m.targets.loser;
      if(t2){
        const [tmid2, tslot2] = t2;
        if(matches[tmid2]) matches[tmid2][`slot${tslot2}`] = m.loser;
      }
    }
  }

  draw();
  saveDebounced();
}

/* ---------- Save / Load / Reset (server-backed) ---------- */
let saveTimeout = null;
function saveDebounced(){ if(saveTimeout) clearTimeout(saveTimeout); saveTimeout = setTimeout(()=>saveState(), 600); }

async function saveState(){
  const payload = {};
  Object.keys(matches).forEach(k=>{
    payload[k] = {
      slot1: matches[k].slot1,
      slot2: matches[k].slot2,
      winner: matches[k].winner,
      loser: matches[k].loser,
      fg1: matches[k].fg1 || "black",
      fg2: matches[k].fg2 || "black"
    };
  });
  document.getElementById('status').innerText = 'Desant...';
  try{
    const res = await fetch(`/admin/fasefinal/api/save/${FASE}`, {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify(payload)
    });
    const j = await res.json();
    document.getElementById('status').innerText = j.ok ? 'Desat' : 'Error desant';
    setTimeout(()=>{ document.getElementById('status').innerText=''; }, 1400);
  }catch(e){
    document.getElementById('status').innerText = 'Error';
    console.error(e);
  }
}

document.getElementById('btnSave').addEventListener('click', ()=>{ saveState(); });
document.getElementById('btnReset').addEventListener('click', async ()=>{
  if(!confirm("Confirmes reiniciar complet el quadre?")) return;
  await fetch(`/admin/fasefinal/api/reset/${FASE}`, { method:'POST' });
  location.reload();
});

/* Attach controls and color title according to fase */
function attachControls(){
  const tit = document.getElementById('titol_fase');
  const fase = FASE.toUpperCase();
  if(fase === 'OR') tit.style.color = 'var(--gold)';
  else if(fase === 'PLATA') tit.style.color = 'var(--silver)';
  else if(fase === 'BRONZE') tit.style.color = 'var(--bronze)';
  else if(fase === 'XOU' || fase === 'SHOW') tit.style.color = 'var(--show)';
}

/* Kick off */
init();
</script>
</body>
</html>








